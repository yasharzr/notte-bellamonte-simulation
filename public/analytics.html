<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notte Bellamonte - Data Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1100px; margin: 0 auto; }
    .header {
      background: linear-gradient(135deg, #6b4423 0%, #3d2817 100%);
      border: 1px solid #d4af37;
      padding: 25px; border-radius: 8px; margin-bottom: 25px; text-align: center;
    }
    .header h1 { font-size: 28px; color: #d4af37; margin-bottom: 8px; }
    .header p { font-size: 14px; color: #aaa; }
    .card {
      background: #2a2a3e; border: 1px solid #444;
      border-radius: 8px; padding: 25px; margin-bottom: 20px;
    }
    .card h2 { color: #d4af37; margin-bottom: 20px; font-size: 18px; border-bottom: 1px solid #444; padding-bottom: 12px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .stat-box {
      background: #3a3a4e; padding: 18px; border-radius: 6px;
      border-left: 4px solid #d4af37; text-align: center;
    }
    .stat-box .label { font-size: 11px; text-transform: uppercase; color: #aaa; letter-spacing: 1px; }
    .stat-box .value { font-size: 28px; font-weight: bold; color: #d4af37; margin-top: 6px; }
    .chart-container { position: relative; width: 100%; max-width: 500px; margin: 0 auto; }
    .pair-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .pair-table th { text-align: left; padding: 12px; background: #3a3a4e; border-bottom: 2px solid #444; color: #d4af37; font-weight: 600; }
    .pair-table td { padding: 12px; border-bottom: 1px solid #444; }
    .pair-table tr:hover { background: #3a3a4e; }
    .join-form {
      background: #2a2a3e; border: 1px solid #444; border-radius: 8px;
      padding: 30px; max-width: 400px; margin: 60px auto; text-align: center;
    }
    .join-form h2 { margin-bottom: 15px; color: #d4af37; }
    .join-form input {
      width: 100%; padding: 12px; background: #3a3a4e; border: 1px solid #555;
      border-radius: 4px; color: #e0e0e0; font-size: 14px; margin-bottom: 12px;
    }
    .join-form input:focus { outline: none; border-color: #d4af37; }
    .button {
      padding: 12px 24px; background: #d4af37; color: #000; border: none;
      border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%;
    }
    .button:hover { background: #e8c547; }
    .hidden { display: none; }
    .tag { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .tag-buy { background: rgba(74,222,128,0.2); color: #4ade80; border: 1px solid #4ade80; }
    .tag-sell { background: rgba(248,113,113,0.2); color: #f87171; border: 1px solid #f87171; }
    .tag-pending { background: rgba(251,191,36,0.2); color: #fbbf24; border: 1px solid #fbbf24; }
    .tag-shotgun { background: rgba(212,175,55,0.2); color: #d4af37; border: 1px solid #d4af37; }
    .tag-timed { background: rgba(96,165,250,0.2); color: #60a5fa; border: 1px solid #60a5fa; }
    .tag-agreed { background: rgba(74,222,128,0.15); color: #4ade80; border: 1px solid #4ade80; }
    .tag-random { background: rgba(251,191,36,0.15); color: #fbbf24; border: 1px solid #fbbf24; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .insight-box {
      background: #3a3a4e; border-left: 4px solid #60a5fa; padding: 16px;
      border-radius: 6px; margin-bottom: 12px; font-size: 14px; line-height: 1.6;
    }
    .insight-box strong { color: #d4af37; }
    .range-line { display: flex; align-items: center; gap: 10px; margin: 8px 0; font-size: 13px; }
    .range-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    @media (max-width: 700px) { .grid-2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <!-- SESSION ID ENTRY -->
    <div id="entryScreen" class="join-form">
      <h2>Data Analysis</h2>
      <p style="color: #aaa; margin-bottom: 20px; font-size: 13px;">Enter the session ID to view results</p>
      <input type="text" id="sessionInput" placeholder="Session ID (e.g., s12abc3def)" autocomplete="off">
      <button class="button" onclick="loadAnalytics()">Load Results</button>
      <div id="entryError" class="hidden" style="margin-top: 12px; color: #f87171; font-size: 13px;"></div>
    </div>

    <!-- ANALYTICS DASHBOARD -->
    <div id="dashboard" class="hidden">
      <div class="header">
        <h1>Notte Bellamonte - Data Analysis</h1>
        <p>Session: <strong id="sessionLabel">--</strong> | Participants: <strong id="participantLabel">0</strong></p>
      </div>

      <!-- SUMMARY STATS -->
      <div class="summary-grid" id="summaryStats"></div>

      <!-- PHASE 1 CHART -->
      <div class="card">
        <h2>Phase 1: Legal Framework Vote Distribution</h2>
        <div class="grid-2">
          <div class="chart-container"><canvas id="phase1Pie"></canvas></div>
          <div><canvas id="phase1Bar"></canvas></div>
        </div>
        <div id="phase1VoteList" style="margin-top: 20px;"></div>
      </div>

      <!-- PHASE 2 CHART -->
      <div class="card">
        <h2>Phase 2: Remedy Selection Distribution</h2>
        <div class="grid-2">
          <div class="chart-container"><canvas id="phase2Pie"></canvas></div>
          <div><canvas id="phase2Bar"></canvas></div>
        </div>
        <div id="phase2VoteList" style="margin-top: 20px;"></div>
      </div>

      <!-- PHASE 3: MECHANISM CHOICE -->
      <div class="card" id="mechanismCard">
        <h2>Phase 3: Mechanism Choice</h2>
        <div id="mechanismStats" class="summary-grid"></div>
        <div class="grid-2">
          <div class="chart-container"><canvas id="mechanismPie"></canvas></div>
          <div id="mechanismDetails"></div>
        </div>
      </div>

      <!-- PHASE 3: PRICE ANALYSIS -->
      <div class="card" id="priceCard">
        <h2>Phase 3: Price Analysis</h2>
        <div id="priceStats" class="summary-grid"></div>
        <div style="margin-bottom:20px;">
          <canvas id="priceChart" height="250"></canvas>
        </div>
        <div id="priceRange"></div>
      </div>

      <!-- PHASE 3: PAIR OUTCOMES -->
      <div class="card" id="pairCard">
        <h2>Phase 3: Pair Outcomes</h2>
        <table class="pair-table" id="pairTable">
          <thead>
            <tr>
              <th>Lucia</th>
              <th>Marco</th>
              <th>Mechanism</th>
              <th>Price</th>
              <th>Decision</th>
              <th>Buyer</th>
            </tr>
          </thead>
          <tbody id="pairTableBody"></tbody>
        </table>
      </div>

      <!-- DISCUSSION PROMPTS -->
      <div class="card" id="discussionCard">
        <h2>Discussion Prompts</h2>
        <div id="discussionPrompts"></div>
      </div>

      <!-- CROSS-ANALYSIS -->
      <div class="card">
        <h2>Cross-Phase Analysis</h2>
        <div id="crossAnalysis"></div>
      </div>
    </div>
  </div>

  <script>
    let analyticsData = null;

    function loadAnalytics() {
      const sid = document.getElementById('sessionInput').value.trim();
      if (!sid) { showError('Please enter a session ID'); return; }

      fetch(`/api/session/${sid}/analytics`)
        .then(r => r.json())
        .then(data => {
          if (data.error) { showError(data.error); return; }
          analyticsData = data;
          document.getElementById('entryScreen').classList.add('hidden');
          document.getElementById('dashboard').classList.remove('hidden');
          render(data);
        })
        .catch(err => showError('Connection error: ' + err.message));
    }

    function showError(msg) {
      const el = document.getElementById('entryError');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    const params = new URLSearchParams(window.location.search);
    const urlSession = params.get('session');
    if (urlSession) {
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('sessionInput').value = urlSession;
        loadAnalytics();
      });
    }

    function render(data) {
      document.getElementById('sessionLabel').textContent = data.sessionId;
      document.getElementById('participantLabel').textContent = data.participantCount;

      renderSummary(data);
      renderPhase1(data.phase1);
      renderPhase2(data.phase2);
      renderMechanismChoice(data.phase3);
      renderPriceAnalysis(data.phase3);
      renderPairOutcomes(data.phase3);
      renderDiscussion(data.phase3);
      renderCrossAnalysis(data);
    }

    function renderSummary(data) {
      const el = document.getElementById('summaryStats');
      const p1Winner = getPhase1Winner(data.phase1.counts);
      const p2Winner = data.phase2.winningRemedy || '--';
      el.innerHTML = `
        <div class="stat-box"><div class="label">Participants</div><div class="value">${data.participantCount}</div></div>
        <div class="stat-box"><div class="label">Phase 1 Winner</div><div class="value" style="font-size:16px;">${p1Winner}</div></div>
        <div class="stat-box"><div class="label">Phase 2 Winner</div><div class="value" style="font-size:16px;">${formatRemedy(p2Winner)}</div></div>
        <div class="stat-box"><div class="label">Pairs Completed</div><div class="value">${data.phase3.completedPairs} / ${data.phase3.totalPairs}</div></div>
      `;
    }

    function getPhase1Winner(counts) {
      const entries = Object.entries(counts);
      entries.sort((a, b) => b[1] - a[1]);
      if (entries[0][1] === 0) return '--';
      const labels = { oppression: 'Oppression', dissolution: 'Dissolution' };
      return labels[entries[0][0]] || entries[0][0];
    }

    function formatRemedy(r) {
      const map = { buyout: 'Buyout', shotgun: 'Shotgun', timedauction: 'Timed Auction', liquidation: 'Liquidation' };
      return map[r] || r;
    }

    // ─── PHASE 1 ─────────────────────────────────────
    function renderPhase1(p1) {
      const labels = ['Oppression (s.241)', 'Dissolution (s.214)'];
      const values = [p1.counts.oppression, p1.counts.dissolution];
      const colors = ['#d4af37', '#f87171'];

      new Chart(document.getElementById('phase1Pie'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }] },
        options: { plugins: { legend: { position: 'bottom', labels: { color: '#ccc', font: { size: 11 } } } }, responsive: true }
      });

      new Chart(document.getElementById('phase1Bar'), {
        type: 'bar',
        data: { labels: ['Oppression', 'Dissolution'], datasets: [{ data: values, backgroundColor: colors, borderRadius: 4 }] },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#aaa', stepSize: 1 }, grid: { color: '#333' } }, x: { ticks: { color: '#aaa' }, grid: { display: false } } }, responsive: true }
      });

      if (p1.votes.length > 0) {
        const choiceLabels = { oppression: 'Oppression', dissolution: 'Dissolution' };
        const choiceColors = { oppression: '#d4af37', dissolution: '#f87171' };
        document.getElementById('phase1VoteList').innerHTML =
          '<h3 style="color:#aaa; font-size:13px; margin-bottom:10px;">Individual Votes</h3>' +
          '<div style="display:flex; flex-wrap:wrap; gap:6px;">' +
          p1.votes.map(v => `<span style="padding:4px 10px; background:${choiceColors[v.choice]}22; border:1px solid ${choiceColors[v.choice]}; border-radius:12px; font-size:11px; color:${choiceColors[v.choice]};">${v.name}: ${choiceLabels[v.choice]}</span>`).join('') +
          '</div>';
      }
    }

    // ─── PHASE 2 ─────────────────────────────────────
    function renderPhase2(p2) {
      const labels = ['Buyout', 'Shotgun', 'Timed Auction', 'Liquidation'];
      const values = [p2.counts.buyout, p2.counts.shotgun, p2.counts.timedauction, p2.counts.liquidation];
      const colors = ['#4ade80', '#d4af37', '#60a5fa', '#f87171'];

      new Chart(document.getElementById('phase2Pie'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }] },
        options: { plugins: { legend: { position: 'bottom', labels: { color: '#ccc', font: { size: 11 } } } }, responsive: true }
      });

      new Chart(document.getElementById('phase2Bar'), {
        type: 'bar',
        data: { labels, datasets: [{ data: values, backgroundColor: colors, borderRadius: 4 }] },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#aaa', stepSize: 1 }, grid: { color: '#333' } }, x: { ticks: { color: '#aaa' }, grid: { display: false } } }, responsive: true }
      });

      if (p2.votes.length > 0) {
        const remedyColors = { buyout: '#4ade80', shotgun: '#d4af37', timedauction: '#60a5fa', liquidation: '#f87171' };
        document.getElementById('phase2VoteList').innerHTML =
          '<h3 style="color:#aaa; font-size:13px; margin-bottom:10px;">Individual Votes</h3>' +
          '<div style="display:flex; flex-wrap:wrap; gap:6px;">' +
          p2.votes.map(v => `<span style="padding:4px 10px; background:${remedyColors[v.remedy]}22; border:1px solid ${remedyColors[v.remedy]}; border-radius:12px; font-size:11px; color:${remedyColors[v.remedy]};">${v.name}: ${formatRemedy(v.remedy)}</span>`).join('') +
          '</div>';
      }
    }

    // ─── MECHANISM CHOICE ────────────────────────────
    function renderMechanismChoice(p3) {
      const ms = p3.mechanismStats;
      if (!ms || (ms.shotgunCount === 0 && ms.timedAuctionCount === 0)) {
        document.getElementById('mechanismCard').classList.add('hidden');
        return;
      }

      document.getElementById('mechanismStats').innerHTML = `
        <div class="stat-box"><div class="label">Shotgun Pairs</div><div class="value">${ms.shotgunCount}</div></div>
        <div class="stat-box"><div class="label">Timed Auction Pairs</div><div class="value">${ms.timedAuctionCount}</div></div>
        <div class="stat-box"><div class="label">Agreed</div><div class="value">${ms.agreedCount}</div></div>
        <div class="stat-box"><div class="label">Random (Disagreed)</div><div class="value">${ms.disagreedCount}</div></div>
      `;

      new Chart(document.getElementById('mechanismPie'), {
        type: 'doughnut',
        data: {
          labels: ['Shotgun', 'Timed Auction'],
          datasets: [{ data: [ms.shotgunCount, ms.timedAuctionCount], backgroundColor: ['#d4af37', '#60a5fa'], borderWidth: 0 }]
        },
        options: { plugins: { legend: { position: 'bottom', labels: { color: '#ccc', font: { size: 11 } } } }, responsive: true }
      });

      // Per-pair mechanism details
      let html = '<h3 style="color:#aaa; font-size:13px; margin-bottom:10px;">Per-Pair Breakdown</h3>';
      p3.pairs.forEach((p, i) => {
        const mechTag = p.chosenMechanism === 'shotgun'
          ? '<span class="tag tag-shotgun">Shotgun</span>'
          : '<span class="tag tag-timed">Timed Auction</span>';
        const agreeTag = p.mechanismAgreed
          ? '<span class="tag tag-agreed">Agreed</span>'
          : '<span class="tag tag-random">Random</span>';
        const voteA = p.mechanismVoteA ? (p.mechanismVoteA === 'shotgun' ? 'Shotgun' : 'Timed') : '?';
        const voteB = p.mechanismVoteB ? (p.mechanismVoteB === 'shotgun' ? 'Shotgun' : 'Timed') : '?';
        html += `<div style="padding:8px 0; border-bottom:1px solid #333; font-size:13px;">
          <strong>Pair ${i+1}:</strong> ${p.partnerA} voted ${voteA}, ${p.partnerB} voted ${voteB} &rarr; ${mechTag} ${agreeTag}
        </div>`;
      });
      document.getElementById('mechanismDetails').innerHTML = html;
    }

    // ─── PRICE ANALYSIS ──────────────────────────────
    function renderPriceAnalysis(p3) {
      const ps = p3.priceStats;
      if (!ps || !ps.avg) {
        document.getElementById('priceCard').classList.add('hidden');
        return;
      }

      const luciaFloor = p3.luciaFloorSell || 4900000;
      const luciaCeiling = p3.luciaCeilingBuy || 4350000;
      const marcoFloor = p3.marcoFloorSell || 4250000;
      const marcoCeiling = p3.marcoCeilingBuy || 4250000;

      document.getElementById('priceStats').innerHTML = `
        <div class="stat-box"><div class="label">Min Price</div><div class="value" style="font-size:18px;">$${ps.min.toLocaleString()}</div></div>
        <div class="stat-box"><div class="label">Max Price</div><div class="value" style="font-size:18px;">$${ps.max.toLocaleString()}</div></div>
        <div class="stat-box"><div class="label">Avg Price</div><div class="value" style="font-size:18px;">$${ps.avg.toLocaleString()}</div></div>
        <div class="stat-box"><div class="label">Median</div><div class="value" style="font-size:18px;">$${ps.median.toLocaleString()}</div></div>
      `;

      // Price bar chart with reference lines
      const completedPairs = p3.pairs.filter(p => p.finalPrice);
      const pairLabels = completedPairs.map((p, i) => `Pair ${i + 1}`);
      const prices = completedPairs.map(p => p.finalPrice);
      const pairColors = completedPairs.map(p => p.chosenMechanism === 'shotgun' ? '#d4af37' : '#60a5fa');

      new Chart(document.getElementById('priceChart'), {
        type: 'bar',
        data: {
          labels: pairLabels,
          datasets: [{ label: 'Final Price ($)', data: prices, backgroundColor: pairColors, borderRadius: 4 }]
        },
        options: {
          plugins: {
            legend: { display: false },
            annotation: {
              annotations: {
                luciaSell: {
                  type: 'line', yMin: luciaFloor, yMax: luciaFloor,
                  borderColor: '#d4af37', borderWidth: 2, borderDash: [6, 3],
                  label: { display: true, content: 'Lucia Sell Min $4.9M', position: 'start', backgroundColor: 'rgba(212,175,55,0.8)', font: { size: 10 } }
                },
                marcoBuy: {
                  type: 'line', yMin: marcoCeiling, yMax: marcoCeiling,
                  borderColor: '#60a5fa', borderWidth: 2, borderDash: [6, 3],
                  label: { display: true, content: 'Marco Buy Max $4.25M', position: 'end', backgroundColor: 'rgba(96,165,250,0.8)', font: { size: 10 } }
                },
                luciaBuy: {
                  type: 'line', yMin: luciaCeiling, yMax: luciaCeiling,
                  borderColor: '#d4af37', borderWidth: 1, borderDash: [3, 3],
                  label: { display: true, content: 'Lucia Buy Max $4.35M', position: 'start', backgroundColor: 'rgba(212,175,55,0.5)', font: { size: 10 } }
                },
              }
            }
          },
          scales: {
            y: { ticks: { color: '#aaa', callback: v => '$' + (v / 1000000).toFixed(1) + 'M' }, grid: { color: '#333' } },
            x: { ticks: { color: '#aaa' }, grid: { display: false } }
          },
          responsive: true,
        }
      });

      // Price range legend
      document.getElementById('priceRange').innerHTML = `
        <h3 style="color:#aaa; font-size:13px; margin-bottom:12px;">Secret Price Constraints</h3>
        <div class="range-line"><div class="range-dot" style="background:#d4af37;"></div> <span><strong>Lucia's</strong> sell minimum: <strong style="color:#d4af37;">$4.9M</strong> (won't sell below this)</span></div>
        <div class="range-line"><div class="range-dot" style="background:#d4af37; opacity:0.5;"></div> <span><strong>Lucia's</strong> buy maximum: <strong style="color:#d4af37;">$4.35M</strong> (can't afford more)</span></div>
        <div class="range-line"><div class="range-dot" style="background:#60a5fa;"></div> <span><strong>Marco's</strong> buy maximum: <strong style="color:#60a5fa;">$4.25M</strong> (investor deal weakens above this)</span></div>
        <div class="range-line"><div class="range-dot" style="background:#60a5fa; opacity:0.5;"></div> <span><strong>Marco's</strong> sell minimum: <strong style="color:#60a5fa;">$4.25M</strong></span></div>
        <div style="margin-top:12px; padding:12px; background:#3a3a4e; border-radius:6px; font-size:13px; color:#aaa;">
          <strong style="color:#d4af37;">Gold bars</strong> = Shotgun mechanism | <strong style="color:#60a5fa;">Blue bars</strong> = Timed Auction mechanism
        </div>
      `;
    }

    // ─── PAIR OUTCOMES TABLE ─────────────────────────
    function renderPairOutcomes(p3) {
      if (p3.totalPairs === 0) {
        document.getElementById('pairCard').classList.add('hidden');
        return;
      }

      const tbody = document.getElementById('pairTableBody');
      tbody.innerHTML = p3.pairs.map(p => {
        const mechTag = p.chosenMechanism === 'shotgun'
          ? '<span class="tag tag-shotgun">Shotgun</span>'
          : p.chosenMechanism === 'timedauction'
            ? '<span class="tag tag-timed">Timed</span>'
            : '<span class="tag tag-pending">Pending</span>';
        const choiceTag = p.choice === 'buy'
          ? '<span class="tag tag-buy">BUY</span>'
          : p.choice === 'sell'
            ? '<span class="tag tag-sell">SELL</span>'
            : '<span class="tag tag-pending">Pending</span>';
        const buyerDisplay = p.buyerName
          ? `${p.buyerName} <span style="color:#888; font-size:11px;">(${p.buyerRole === 'lucia' ? 'Lucia' : 'Marco'})</span>`
          : '--';
        return `<tr>
          <td>${p.partnerA}</td>
          <td>${p.partnerB}</td>
          <td>${mechTag}</td>
          <td>${p.finalPrice ? '$' + p.finalPrice.toLocaleString() : '--'}</td>
          <td>${choiceTag}</td>
          <td>${buyerDisplay}</td>
        </tr>`;
      }).join('');
    }

    // ─── DISCUSSION PROMPTS ──────────────────────────
    function renderDiscussion(p3) {
      if (p3.totalPairs === 0) {
        document.getElementById('discussionCard').classList.add('hidden');
        return;
      }

      const completed = p3.pairs.filter(p => p.finalPrice);
      const prices = completed.map(p => p.finalPrice);
      const luciaFloor = p3.luciaFloorSell || 4900000;
      const marcoCeiling = p3.marcoCeilingBuy || 4250000;

      let prompts = [];

      // Price range analysis
      if (prices.length > 0) {
        const avg = p3.priceStats.avg;
        const belowMarco = prices.filter(p => p <= marcoCeiling).length;
        const aboveLucia = prices.filter(p => p >= luciaFloor).length;
        const inBetween = prices.filter(p => p > marcoCeiling && p < luciaFloor).length;

        prompts.push(`<strong>${completed.length}</strong> pairs completed negotiations. The average transaction price was <strong>$${avg.toLocaleString()}</strong>.`);

        if (belowMarco > 0) {
          prompts.push(`<strong>${belowMarco}</strong> pair(s) settled at or below Marco's buy ceiling ($4.25M). These Lucias may have undervalued their position or felt pressure to close.`);
        }
        if (aboveLucia > 0) {
          prompts.push(`<strong>${aboveLucia}</strong> pair(s) settled at or above Lucia's sell floor ($4.9M). These Marcos may have overpaid relative to their secret constraint.`);
        }
        if (inBetween > 0) {
          prompts.push(`<strong>${inBetween}</strong> pair(s) settled between Marco's ceiling and Lucia's floor — a zone where neither side's secret constraint was fully satisfied.`);
        }
      }

      // Mechanism comparison
      const ms = p3.mechanismStats;
      if (ms.shotgunCount > 0 && ms.timedAuctionCount > 0) {
        const shotgunPrices = completed.filter(p => p.chosenMechanism === 'shotgun').map(p => p.finalPrice);
        const timedPrices = completed.filter(p => p.chosenMechanism === 'timedauction').map(p => p.finalPrice);
        if (shotgunPrices.length && timedPrices.length) {
          const avgShotgun = Math.round(shotgunPrices.reduce((a, b) => a + b, 0) / shotgunPrices.length);
          const avgTimed = Math.round(timedPrices.reduce((a, b) => a + b, 0) / timedPrices.length);
          prompts.push(`Shotgun pairs averaged <strong>$${avgShotgun.toLocaleString()}</strong> vs Timed Auction pairs at <strong>$${avgTimed.toLocaleString()}</strong>. Did the mechanism affect the price?`);
        }
      }

      // Buyer role analysis
      const luciaBuyers = completed.filter(p => p.buyerRole === 'lucia').length;
      const marcoBuyers = completed.filter(p => p.buyerRole === 'marco').length;
      if (luciaBuyers > 0 || marcoBuyers > 0) {
        prompts.push(`<strong>${luciaBuyers}</strong> Lucia(s) ended up buying vs <strong>${marcoBuyers}</strong> Marco(s). Given Marco's secret investor backing and Lucia's limited cash, who had the stronger buying position?`);
      }

      // Agreement vs random
      if (ms.disagreedCount > 0) {
        prompts.push(`<strong>${ms.disagreedCount}</strong> pair(s) disagreed on mechanism and were randomly assigned. Did the randomly assigned mechanism lead to different outcomes?`);
      }

      // Debrief discussion questions
      prompts.push('<strong style="color:#60a5fa;">Debrief Question:</strong> Both sides received secret price constraints. Did having private information help you negotiate more effectively, or did it create a false sense of certainty about your position?');

      prompts.push('<strong style="color:#60a5fa;">Debrief Question:</strong> In the shotgun clause, the offeror sets a price that the responder can either buy or sell at. Does this mechanism produce "fair" prices? Why might courts prefer this over other remedies?');

      if (prices.length > 0) {
        const avg = p3.priceStats.avg;
        if (avg < 4250000) {
          prompts.push('<strong style="color:#60a5fa;">Key Insight:</strong> The average price fell below Marco\'s buy ceiling ($4.25M). This suggests Lucias may have been under more pressure than expected. Was Marco\'s dissolution threat effective as leverage even though it was a bluff?');
        } else if (avg > 4900000) {
          prompts.push('<strong style="color:#60a5fa;">Key Insight:</strong> The average price exceeded Lucia\'s sell floor ($4.9M). Marcos may have overpaid. Did Lucia\'s oppression claim create more leverage than expected?');
        } else {
          prompts.push('<strong style="color:#60a5fa;">Key Insight:</strong> The average price landed in the zone between Marco\'s ceiling and Lucia\'s floor — a range where neither side\'s secret constraint was fully met. This mirrors real corporate disputes where both sides must compromise.');
        }
      }

      prompts.push('<strong style="color:#60a5fa;">Debrief Question:</strong> If you were the court, which remedy (oppression vs dissolution) would you have granted? How does the remedy choice affect the balance of power between shareholders?');

      prompts.push('<strong style="color:#60a5fa;">Debrief Question:</strong> In a real case, would the absence of a shareholder agreement make this dispute more or less predictable? What provisions should Lucia and Marco have included when they first became co-owners?');

      const el = document.getElementById('discussionPrompts');
      el.innerHTML = prompts.map(p => `<div class="insight-box">${p}</div>`).join('');
    }

    // ─── CROSS ANALYSIS ──────────────────────────────
    function renderCrossAnalysis(data) {
      const el = document.getElementById('crossAnalysis');
      if (!data.phase1.votes.length || !data.phase2.votes.length) {
        el.innerHTML = '<p style="color:#aaa;">Not enough data for cross-phase analysis.</p>';
        return;
      }

      const nameMap = {};
      data.phase1.votes.forEach(v => { nameMap[v.name] = { phase1: v.choice }; });
      data.phase2.votes.forEach(v => {
        if (!nameMap[v.name]) nameMap[v.name] = {};
        nameMap[v.name].phase2 = v.remedy;
      });

      const choiceLabels = { oppression: 'Oppression', dissolution: 'Dissolution' };
      const remedyLabels = { buyout: 'Buyout', shotgun: 'Shotgun', timedauction: 'Timed Auction', liquidation: 'Liquidation' };

      let html = '<table class="pair-table"><thead><tr><th>Student</th><th>Phase 1 Vote</th><th>Phase 2 Vote</th></tr></thead><tbody>';
      Object.entries(nameMap).forEach(([name, votes]) => {
        html += `<tr><td>${name}</td><td>${choiceLabels[votes.phase1] || '--'}</td><td>${remedyLabels[votes.phase2] || '--'}</td></tr>`;
      });
      html += '</tbody></table>';

      const correlations = {};
      ['oppression', 'dissolution'].forEach(p1 => {
        correlations[p1] = { buyout: 0, shotgun: 0, timedauction: 0, liquidation: 0 };
      });
      Object.values(nameMap).forEach(v => {
        if (v.phase1 && v.phase2 && correlations[v.phase1]) {
          correlations[v.phase1][v.phase2]++;
        }
      });

      html += '<h3 style="color:#d4af37; margin-top:25px; margin-bottom:12px;">Voting Correlation</h3>';
      html += '<p style="color:#aaa; font-size:13px; margin-bottom:12px;">How did students who voted for each legal framework choose their remedy?</p>';

      ['oppression', 'dissolution'].forEach(p1 => {
        const c = correlations[p1];
        const total = Object.values(c).reduce((a, b) => a + b, 0);
        if (total === 0) return;
        html += `<div style="margin-bottom:12px;"><strong style="color:#d4af37;">${choiceLabels[p1]}</strong> voters (${total}):<br>`;
        html += Object.entries(c).filter(([_, v]) => v > 0).map(([r, v]) =>
          `<span style="margin-right:12px; font-size:13px;">${remedyLabels[r]}: ${v} (${Math.round(v / total * 100)}%)</span>`
        ).join('');
        html += '</div>';
      });

      el.innerHTML = html;
    }
  </script>
</body>
</html>
